<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pensum Interactivo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    #controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    #fileInput {
      padding: 6px;
    }
    #carreraSelect {
      padding: 6px;
    }
    #pensumContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .semestre {
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .semestre h2 {
      margin-top: 0;
      color: #555;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }
    .curso {
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 5px;
      cursor: pointer;
      background-color: #fafafa;
      transition: background 0.3s, transform 0.2s;
    }
    .curso:hover {
      background-color: #e8f0fe;
      transform: translateY(-2px);
    }
    .curso.highlight {
      background-color: #ffeb3b;
      border-color: #fbc02d;
      box-shadow: 0 0 8px rgba(251,192,45,0.6);
    }
  </style>
</head>
<body>
  <h1>Pensum Interactivo</h1>
  <div id="controls">
    <input type="file" id="fileInput" multiple accept=".plfp" />
    <select id="carreraSelect">
      <option value="">-- Seleccione carrera --</option>
    </select>
  </div>
  <div id="pensumContainer"></div>

  <script>
    // Almacena cada pensum cargado
    const pensums = [];
    const visitedGlobal = new Set();

    document.getElementById('fileInput').addEventListener('change', handleFiles);
    document.getElementById('carreraSelect').addEventListener('change', () => {
      renderPensum(document.getElementById('carreraSelect').value);
    });

    // Procesa los archivos .plfp seleccionados
    function handleFiles(event) {
      pensums.length = 0;
      const files = Array.from(event.target.files);
      const reads = files.map(file => file.text().then(text => parsePLFP(text)));
      Promise.all(reads).then(results => {
        results.forEach(p => pensums.push(p));
        populateSelect();
      });
    }

    // Llena el <select> con las carreras
    function populateSelect() {
      const sel = document.getElementById('carreraSelect');
      sel.innerHTML = '<option value="">-- Seleccione carrera --</option>';
      pensums.forEach((p, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = p.carrera;
        sel.appendChild(opt);
      });
    }

    // Renderiza el pensum de la carrera seleccionada
    function renderPensum(idx) {
      const container = document.getElementById('pensumContainer');
      container.innerHTML = '';
      if (idx === '') return;
      const p = pensums[idx];
      p.semestres.forEach(s => {
        const divSem = document.createElement('div');
        divSem.className = 'semestre';
        const h2 = document.createElement('h2');
        h2.textContent = `Semestre ${s.numero}`;
        divSem.appendChild(h2);
        s.cursos.forEach(c => {
          const divC = document.createElement('div');
          divC.className = 'curso';
          divC.id = `curso-${s.numero}-${c.id}`;
          divC.dataset.id = c.id;
          divC.dataset.prerequisitos = JSON.stringify(c.prerrequisitos);
          divC.textContent = `${c.id}: ${c.nombre}`;
          divC.addEventListener('click', () => highlightChain(c.id));
          divSem.appendChild(divC);
        });
        container.appendChild(divSem);
      });
    }

    // Resalta el curso y su cadena de prerrequisitos
    function highlightChain(startId) {
      // Limpia resaltados previos
      document.querySelectorAll('.curso.highlight').forEach(el => el.classList.remove('highlight'));
      const queue = [startId];
      const visited = new Set();
      while (queue.length) {
        const id = queue.shift();
        if (visited.has(id)) continue;
        visited.add(id);
        // Selecciona todos los cursos con data-id = id
        const els = document.querySelectorAll(`.curso[data-id='${id}']`);
        els.forEach(el => el.classList.add('highlight'));
        // Obtiene sus prerrequisitos desde el atributo data
        els.forEach(el => {
          const prereq = JSON.parse(el.dataset.prerequisitos || '[]');
          prereq.forEach(pr => {
            if (!visited.has(pr)) queue.push(pr);
          });
        });
      }
    }

    // Parser para archivos .plfp
    function parsePLFP(text) {
      const carreraMatch = text.match(/Carrera:\s*"([^"]+)"/);
      const carrera = carreraMatch ? carreraMatch[1] : 'Desconocida';
      const semestres = [];
      const semestreRegex = /Semestre:\s*(\d+)\s*\{([\s\S]*?)\}/g;
      let semMatch;
      while ((semMatch = semestreRegex.exec(text))) {
        const numero = semMatch[1];
        const body = semMatch[2];
        const cursos = [];
        const cursoRegex = /Curso:\s*(\d+)\s*\{[\s\S]*?Nombre:\s*"([^"]+)";[\s\S]*?Prerrequisitos:\s*\(([^)]*)\);/g;
        let curMatch;
        while ((curMatch = cursoRegex.exec(body))) {
          const id = curMatch[1];
          const nombre = curMatch[2];
          const prereqStr = curMatch[3].trim();
          const prerrequisitos = prereqStr ? prereqStr.split(',').map(s => s.trim()) : [];
          cursos.push({ id, nombre, prerrequisitos });
        }
        semestres.push({ numero, cursos });
      }
      return { carrera, semestres };
    }
  </script>
</body>
</html>
